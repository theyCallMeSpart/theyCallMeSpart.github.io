+++
title = "Practical Malware Analysis Labs: Lab 1"
date = 2023-03-19
description = "Practical Malware Analysis Labs: Lab 1"
tags = [
    "Malware",
    "Practical Malware Analysis Labs",
    "Training"
]
categories = [
    "Malware",
    "Practical Malware Analysis Labs",
    "Training"
]
series = ["Practical Malware Analysis Labs"]
+++

# Practical Malware Analysis Labs: Lab 1

## Lab 1

The purpose of the labs is to give you an opportunity to practice the skills  taught in the chapter. In order to simulate realistic malware analysis you will be given little or no information about the program you are analyzing. Like all of the labs throughout this book, the basic static analysis lab files have been given generic names to simulate unknown malware, which typically use meaningless or misleading names. Each of the labs consists of a malicious file, a few questions, short answers to the questions, and a detailed analysis of the malware. The solutions to the labs are included in Appendix C. The labs include two sections of answers. The first section consists of short answers, which should be used if you did the lab yourself and just want to check your work. The second section includes detailed explanations for you to follow along with our solution and learn how we found the answers to the questions posed in each lab.  

### Lab 1-1

This lab uses the files **Lab01-01.exe** and **Lab01-01.dll**. Use the tools and techniques described in the chapter to gain information about the files and answer the questions below.  

1. **Upload the files to http://www.VirusTotal.com/ and view the reports. Does either file match any existing antivirus signatures?**

`Lab01-01.exe` is identified as a `trojan.ulise/aenjaris` with a score of **50/69**.
`Lab01-01.dll` is identified as `trojan.ulise/skeeyah` with a score of **44/69**.

2. **When were these files compiled?**

`Lab01-01.exe` was compiled in 2010-12-19 16:16:19 UTC
`Lab01-01.dll` was compiled in 2010-12-19 16:16:38 UTC

3. **Are there any indications that either of these files is packed or obfuscated? If so, what are these indicators?**

No, there are no indicators these files are packed or obfuscated. They have been compiled with Microsoft Visual C++ 6.0, strings are readable, entropy isn't abnormal, and the virtual size is close to the raw size. You can check this information with `PEiD`, `PEStudio` or `PEView`.

4. **Do any imports hint at what this malware does? If so, which imports are they?**

`Lab01-01.exe` imports `CopyFileA`, `FindFirstFileA` and `FindNextFileA`.
`Lab01-01.dll` imports via ordinal `socket` `closesocket` `connect` `send` from `WS2_32.dll` which are networking capabilities. It also imports `Sleep` and `CreateMutexA` from `Kernel32.dll` as evasion technique.

5. **Are there any other files or host-based indicators that you could look for on infected systems?**

In the strings in `Lab01-01.exe` we can find `C:\windows\system32\kerne132.dll` which is a misspelling of `Kernel32.dll`. There is a chance `kerne132.dll` is dropped on the system during the `Lab01-01.exe` execution.

6. **What network-based indicators could be used to find this malware on infected machines?**

`Lab01-01.dll` has the IP address `127[.]26[.]152[.]13` readable in the strings.

7. **What would you guess is the purpose of these files?**

Based on the static analysis the DLL is certainly a remote access trojan (RAT). 
The executable is here to drop and/or execute the DLL on the system.
`127.26.152.13` is most likely the C2 server IP address.

### Lab 1-2

**Analyze the file Lab01-02.exe.**

1. **Upload the `Lab01-02.exe` file to http://www.VirusTotal.com/. Does it match any existing antivirus definitions?**

`Lab01-02.exe` is identified as a trojan.ulise/trojanclicker with a score of **51/69**.

2. **Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.**

Sections names are `UPX0`, `UPX1`, `UPX2`.
`Lab01-02.exe` imports `LoadLibraryA`, `GetProcAddress`, `VirtualProctect` which are common API call use by packed binary.
Strings only contains `UPX` and imports names (the rest is gibberish).
The sections `Virtual Size` is different from the size of the `Raw Data`. The section takes more space in memory than on disk. This is very common for a packed binary. `PEiD` and `Detect It Easy` find it packed with `UPX`.

3. **Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?**

Imports `InternetOpenUrlA` and `InternetOpenA` from `WININET.dll`.  
Imports `CreateServiceA` and `StartServiceCtrlDispatcherA` from `ADVAPI32.dll`.

From this information we can guess it start a service and connects to the internet.

4. **What host- or network-based indicators could be used to identify this malware on infected machines?**

`malservice` as host based indicators and `hxxp[://]www[.]malwareanalysisbook[.]com` as network based indicator. We can assume that `malservice` is going to start a connection to `hxxp[://]www[.]malwareanalysisbook[.]com`.

### Lab 1-3

**Analyze the file Lab01-03.exe.**

1. **Upload the `Lab01-03.exe` file to http://www.VirusTotal.com/. Does it match any existing antivirus definitions?**

`Lab01-03.exe` is identified as a `trojan.graftor/genome` with a score of **58/69**.

2. **Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.**

`Lab01-03.exe` imports only `LoadLibraryA` and `GetProcAddress` which are common API call use by packed binary.
Strings only contains the two imports names (the rest is also gibberish).
The sections `Virtual Size` is different than the size of the `Raw Data`. The section takes more space in memory than on disk. This is very common for a packed binary.
`PEiD` and `Detect It Easy` find it packed with `FSG 1.0`.
Unpacking is fairly easy to do.

It follows a pattern in order to get all the DLL names that it wants to use, then calls `LoadLibraryA` and  `GetProcAddress` to resolve them. *Trace into* just after the DLL export routine (when the jump is taken). You should land at the start of the unpacked program (`0x401090`).

3. **Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?**

The unpacked binary imports `CoCreateInstance`, `OleInitialize`,  `OleUninitialize`, `SysAllocString` and `SysFreeString` from `msvcrt.dll`, `oleaut32.dll` and `ole32.dll`. So nothing suspicious.

4. **What host- or network-based indicators could be used to identify this malware on infected machines?**

`hxxp[://]www[.]malwareanalysisbook[.]com` is a network-base indicators.

### Lab 1-4

**Analyze the file Lab01-04.exe.**

1. **Upload the Lab01-04.exe file to http://www.VirusTotal.com/. Does it match any existing antivirus definitions?**

`Lab01-04.exe` is identified as a `trojan.graftor/genome` with a score of **53/69**.

2. **Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.**

`Lab01-04.exe` doesn't seem packed or obfuscated. Imports and strings are readable.
Sections `Virtual Size` and the `Raw Data` are close in size.

3. **When was this program compiled?**

Compile time is `Fri Aug 30 22:26:59 2019 | UTC`.

4. **Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?**  

`LookupPrivilegeValueA` (Enumeration) from `ADVAPI32.dll`: `LookupPrivilegeValueA` is used to retrieve the locally unique identifier (LUID) used on a specified system to locally represent the specified privilege name. This function is commonly used by malware in process injection or token stealing.  

`OpenProcess` (Injection) from `KERNEL32.dll`: `OpenProcess` is used to get a handle on a process. This function is commonly used by malware during process injection.  
`OpenProcessToken` (Injection) from `ADVAPI32.dll`: `OpenProcessToken` is used to open the access token associated with a process.  

`AdjustTokenPrivileges` (Injection) from `ADVAPI32.dll`: `AdjustTokenPrivileges` is used to enable or disable specific access privileges. Malware that performs process injection often calls this function to gain additional permissions.  

`CreateRemoteThread` (Injection) from `KERNEL32.dll`: `CreateRemoteThread` is used to create a thread that runs in the virtual address space of another process.
`WriteFile` (Helper) from `KERNEL32.dll`: `WriteFile` is used to write data to the specified file or input/output (I/O) device.  

`MoveFileA` (Helper) from `KERNEL32.dll`: `MoveFileA` is used to move an existing file or a directory, including its children.  

`WinExec` (Internet) from `KERNEL32.dll`: `WinExec` is used to allow the execution of an application.

5. **What host- or network-based indicators could be used to identify this malware on infected machines?**

`hxxp[://]www[.]malwareanalysisbook[.]com` is a network-base indicators.
`\winup.exe`, `\system32\wupdmgrd.exe` and `\system32\wupdmgr.exe` are host-based indicators.

6. **This file has one resource in the resource section. Use Resource Hacker to examine that resource, and then use it to extract the resource. What can you learn from the resource?**

You can dump it with PE-bear. The exported binary import `WinExec` and `URLDownloadToFile` from `URLMON.DLL` indicating it will download and execute a file.
There is a high probability for `updated.exe` from `hxxp[://]www[.]malwareanalysisbook[.]com`.
